{% extends 'layout.html' %}

{% block title %}Financial Dashboard - Spend Analysis{% endblock %}

{% block additional_head %}
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <h1>Financial Dashboard</h1>
    
    <div class="summary-stats">
        <div class="stat-card">
            <h3>${{ "%.2f"|format(summary_stats.total_income) }}</h3>
            <p>Total Income</p>
        </div>
        <div class="stat-card">
            <h3>${{ "%.2f"|format(summary_stats.total_expenses) }}</h3>
            <p>Total Expenses</p>
        </div>
        <div class="stat-card">
            <h3>${{ "%.2f"|format(summary_stats.savings) }}</h3>
            <p>Savings</p>
        </div>
        <div class="stat-card">
            <h3>{{ "%.1f"|format(summary_stats.savings_rate) }}%</h3>
            <p>Savings Rate</p>
        </div>
    </div>
    
    <div class="grid-2">
        <div class="card">
            <div class="card-header">Monthly Income vs. Expenses</div>
            <div class="card-body">
                <div class="chart-container">{{ income_vs_expenses|safe }}</div>
            </div>
        </div>
        <div class="card">
            <div class="card-header">Spending by Category</div>
            <div class="card-body">
                <div class="chart-container">{{ pie_chart|safe }}</div>
            </div>
        </div>
    </div>
    
    <div class="grid-3">
        <div class="card">
            <div class="card-header">Spending by Month</div>
            <div class="card-body">
                <div class="chart-container">{{ bar_chart|safe }}</div>
            </div>
        </div>
        <div class="card">
            <div class="card-header">Essential vs. Non-Essential</div>
            <div class="card-body">
                <div class="chart-container">{{ essential_ratio|safe }}</div>
            </div>
        </div>
        <div class="card">
            <div class="card-header">Dining vs. Groceries</div>
            <div class="card-body">
                <div class="chart-container">{{ dining_vs_groceries|safe }}</div>
            </div>
        </div>
    </div>
    
    <div class="grid-2">
        <div class="card">
            <div class="card-header">Spending Calendar</div>
            <div class="card-body">
                <div class="chart-container">{{ calendar|safe }}</div>
            </div>
        </div>
        <div class="card">
            <div class="card-header">Top Spending Categories</div>
            <div class="card-body">
                <div class="chart-container">{{ top_categories|safe }}</div>
            </div>
        </div>
    </div>
    
    <div class="grid-2">
        <div class="card">
            <div class="card-header">Category Growth Over Time</div>
            <div class="card-body">
                <div class="chart-container">{{ category_growth|safe }}</div>
            </div>
        </div>
        <div class="card">
            <div class="card-header">Income Flow</div>
            <div class="card-body">
        <!-- Row 2: Monthly Trends and Calendar View -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">Monthly Expense Trends</div>
                    <div class="card-body">
                        {{ bar_chart|safe }}
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">Top Spending Categories</div>
                    <div class="card-body">
            <div class="card-body">
                <div class="chart-container">{{ food_forecast|safe }}</div>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">Spending Forecast</div>
        <div class="card-body">
            <div class="chart-container">{{ forecast|safe }}</div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">Recent Transactions</div>
        <div class="card-body">
            {{ transaction_table|safe }}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Function to update chart themes
    window.updateChartThemes = function(theme) {
        const backgroundColor = theme === 'dark' ? '#343a40' : '#ffffff';
        const textColor = theme === 'dark' ? '#f8f9fa' : '#212529';
        const gridColor = theme === 'dark' ? '#495057' : '#dee2e6';
        
        const charts = document.querySelectorAll('.js-plotly-plot');
        
        // Update each Plotly chart with the new theme
        charts.forEach(chart => {
            if (chart && chart._fullLayout) {
                Plotly.relayout(chart, {
                    'paper_bgcolor': backgroundColor,
                    'plot_bgcolor': backgroundColor,
                    'font.color': textColor,
                    'xaxis.gridcolor': gridColor,
                    'yaxis.gridcolor': gridColor
                });
            }
        });
    };
    
    // Apply initial theme to charts
    document.addEventListener('DOMContentLoaded', () => {
        const currentTheme = localStorage.getItem('theme') || 'light';
        setTimeout(() => {
            updateChartThemes(currentTheme);
        }, 500); // Small delay to ensure charts are loaded
    });
</script>
{% endblock %}