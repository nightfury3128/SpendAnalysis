{% extends 'layout.html' %}

{% block title %}Financial Dashboard - Spend Analysis{% endblock %}

{% block additional_head %}
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Dashboard Header with Navigation -->
    <div class="dashboard-header">
        <h1>Financial Dashboard</h1>
        <div class="dashboard-nav">
            <a href="#overview" class="nav-link active">Overview</a>
            <a href="#spending" class="nav-link">Spending Analysis</a>
            <a href="#forecasts" class="nav-link">Forecasts</a>
            <a href="#transactions" class="nav-link">Transactions</a>
        </div>
    </div>

    <!-- Overview Section -->
    <section id="overview" class="dashboard-section">
        <h2>Overview</h2>
        
        <div class="summary-stats">
            <div class="stat-card">
                <h3>${{ "%.2f"|format(summary_stats.total_income) }}</h3>
                <p>Total Income</p>
            </div>
            <div class="stat-card">
                <h3>${{ "%.2f"|format(summary_stats.total_expenses) }}</h3>
                <p>Total Expenses</p>
            </div>
            <div class="stat-card">
                <h3>${{ "%.2f"|format(summary_stats.savings) }}</h3>
                <p>Savings</p>
            </div>
            <div class="stat-card">
                <h3>{{ "%.1f"|format(summary_stats.savings_rate) }}%</h3>
                <p>Savings Rate</p>
            </div>
        </div>
        
        <div class="grid-2">
            <div class="card">
                <div class="card-header">Monthly Income vs. Expenses</div>
                <div class="card-body">
                    <div class="chart-container">{{ income_vs_expenses|safe }}</div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">Essential vs. Non-Essential</div>
                <div class="card-body">
                    <div class="chart-container">{{ essential_ratio|safe }}</div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Spending Analysis Section -->
    <section id="spending" class="dashboard-section">
        <h2>Spending Analysis</h2>
        
        <div class="grid-3">
            <div class="card">
                <div class="card-header">Spending by Category</div>
                <div class="card-body">
                    <div class="chart-container">{{ pie_chart|safe }}</div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">Top Categories</div>
                <div class="card-body">
                    <div class="chart-container">{{ top_categories|safe }}</div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">Monthly Spending Trend</div>
                <div class="card-body">
                    <div class="chart-container">{{ bar_chart|safe }}</div>
                </div>
            </div>
        </div>
        
        <div class="grid-2">
            <div class="card">
                <div class="card-header">Category Growth</div>
                <div class="card-body">
                    <div class="chart-container">{{ category_growth|safe }}</div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">Dining vs. Groceries</div>
                <div class="card-body">
                    <div class="chart-container">{{ dining_vs_groceries|safe }}</div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Forecasts Section -->
    <section id="forecasts" class="dashboard-section">
        <h2>Spending Forecasts</h2>
        
        <div class="grid-2">
            <div class="card">
                <div class="card-header">Overall Spending Forecast</div>
                <div class="card-body">
                    <div class="chart-container">{{ forecast|safe }}</div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">Rent Forecast</div>
                <div class="card-body">
                    <div class="chart-container">{{ rent_forecast|safe }}</div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Transactions Section -->
    <section id="transactions" class="dashboard-section">
        <h2>Recent Transactions</h2>
        
        <div class="card">
            <div class="card-header">Transaction History</div>
            <div class="card-body">
                <div class="transaction-table-container">
                    {{ transaction_table|safe }}
                </div>
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Function to update chart themes
    window.updateChartThemes = function(theme) {
        const backgroundColor = theme === 'dark' ? '#343a40' : '#ffffff';
        const textColor = theme === 'dark' ? '#f8f9fa' : '#212529';
        const gridColor = theme === 'dark' ? '#495057' : '#dee2e6';
        
        const charts = document.querySelectorAll('.js-plotly-plot');
        
        // Update each Plotly chart with the new theme
        charts.forEach(chart => {
            if (chart && chart._fullLayout) {
                Plotly.relayout(chart, {
                    'paper_bgcolor': backgroundColor,
                    'plot_bgcolor': backgroundColor,
                    'font.color': textColor,
                    'xaxis.gridcolor': gridColor,
                    'yaxis.gridcolor': gridColor
                });
            }
        });
    };
    
    // Apply initial theme to charts
    document.addEventListener('DOMContentLoaded', () => {
        const currentTheme = localStorage.getItem('theme') || 'light';
        setTimeout(() => {
            updateChartThemes(currentTheme);
        }, 500); // Small delay to ensure charts are loaded
        
        // Smooth scrolling for navigation links
        const navLinks = document.querySelectorAll('.nav-link');
        
        navLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Remove active class from all links
                navLinks.forEach(l => l.classList.remove('active'));
                
                // Add active class to clicked link
                this.classList.add('active');
                
                const targetId = this.getAttribute('href').substring(1);
                const targetSection = document.getElementById(targetId);
                
                if (targetSection) {
                    window.scrollTo({
                        top: targetSection.offsetTop - 80,
                        behavior: 'smooth'
                    });
                }
            });
        });
        
        // Highlight active section on scroll
        const sections = document.querySelectorAll('.dashboard-section');
        
        window.addEventListener('scroll', function() {
            let current = '';
            const scrollPos = window.scrollY + 100;
            
            sections.forEach(section => {
                const sectionTop = section.offsetTop;
                const sectionHeight = section.offsetHeight;
                
                if (scrollPos >= sectionTop && scrollPos < sectionTop + sectionHeight) {
                    current = section.getAttribute('id');
                }
            });
            
            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === `#${current}`) {
                    link.classList.add('active');
                }
            });
        });
    });
</script>
{% endblock %}